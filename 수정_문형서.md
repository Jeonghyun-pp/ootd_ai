# 수정 문형서

## 1. 작업 목적
- 기존 코드에서 **실제 추론 경로가 동작하지 않던 문제**를 해결
- 제공된 `model/artifacts.pt`를 기준으로 **실제 추천 추론 가능 상태**로 정비
- 추가 요청사항 반영:
  - 학습 데이터 기준으로 `스타일` 값 우선 반영
  - `원피스`를 상/하의 합성 처리하지 않고 **별도 추천 타입**으로 분리

---

## 2. 핵심 이슈와 해결

### 이슈 A. 모델 포맷 불일치
- 기존 `ml-server`는 `best_model.pt` 단일 가중치 로딩 구조
- 실제 제공 파일은 `artifacts.pt` (인코더 상태 + vocab/maps + 인덱스 포함)

해결:
- `ml-server/app/model_loader.py`를 전면 교체하여 `artifacts.pt` 기반 로더 구현
- 텍스트/아이템 인코더 재구성, vocab/maps 로딩, 안전한 토큰화/인코딩 처리 추가

### 이슈 B. Next API ↔ ML 서버 스키마 불일치
- 기존 요청/응답 구조가 서로 달라 ML 추론 경로 실패 가능

해결:
- `ml-server/app/main.py`에서 요청 스키마를 Next API 기준(`user_context`, `closet_items`, `top_k`)으로 정렬
- `src/app/api/recommend/route.ts`에서 ML 응답 매핑 강화 및 예외 처리 보강

### 이슈 C. CLIP 실패 시 ML 추론까지 중단
- 벡터 검색 실패하면 ML 추천 자체가 스킵되는 구조

해결:
- 벡터 narrowing을 optional로 변경
- CLIP/pgvector 실패 시에도 전체 아이템으로 ML 추론 진행 후 최종 fallback 적용

### 이슈 D. 원피스 처리 방식
- 기존은 UI 호환을 위해 `top == bottom == dress` 형태

해결:
- `dress` 전용 추천 타입 도입
- `outfit_type: "dress"` + `dress_id` 응답 구조로 분리
- 프론트 렌더링도 원피스 카드 독립 처리

---

## 3. 파일별 수정 내역

### `ml-server/app/model_loader.py`
- `artifacts.pt` 로딩 로직 구현
- `TextEncoder`, `ItemEncoder`, `ArtifactsBundle` 추가
- 한글 토큰 정규식 수정
- 빈 텍스트 입력 시 transformer 오류 방어 로직 추가

### `ml-server/app/predictor.py`
- 추론 로직 전면 재작성
- 옷장 아이템 속성 → 학습 feature map 인덱싱 로직 구현
- 스타일 매핑 우선순위: `스타일` > `style` > `서브스타일` > `sub_style`
- 추천 결과 타입 분리:
  - `two_piece` (`top_id`, `bottom_id`, `outer_id`)
  - `dress` (`dress_id`, `outer_id`)

### `ml-server/app/main.py`
- FastAPI 스키마 재정의
- `RecommendationRow`에 `outfit_type`, `dress_id` 추가
- startup 시 artifacts 로딩하도록 변경

### `ml-server/app/__init__.py`
- 패키지 인식용 파일 추가

### `src/app/api/recommend/route.ts`
- ML 호출 로직 개선 (벡터 검색 optional)
- ML 응답 `dress/two_piece` 매핑 반영
- fallback 결과도 `dress` 타입 분리

### `src/app/ootd/page.tsx`
- 추천 결과 파싱 시 `rec.type === "dress"` 분기 처리 추가

### `src/components/ootd/RecommendationResult.tsx`
- 추천 타입 확장 (`two_piece | dress`)
- 원피스 전용 렌더링 영역 추가

---

## 4. 데이터 확인 내용 (사용자 제공 CSV)

대상 파일:
- `C:\Users\hsmoo\Downloads\kfashion_train_label_filled_utf8sig_plus678.csv`

확인 결과:
- 컬럼 존재: `스타일`, `서브스타일`, `part`, `카테고리`, `날씨`
- `스타일`은 실제 유효 클래스 분포를 가지므로 추론 매핑에 반영 완료

---

## 5. 검증 결과

실행한 검증:
- `python -m compileall ml-server/app` 통과
- `npx tsc --noEmit` 통과
- 샘플 추론 테스트에서 `dress`/`two_piece` 모두 결과 반환 확인

---

## 6. 실행 방법

1. ML 서버 실행
```bash
cd ml-server
uvicorn app.main:app --host 0.0.0.0 --port 8000
```

2. Next 서버 실행
```bash
npm run dev
```

3. 환경변수 확인
- `ML_SERVER_URL=http://localhost:8000`

---

## 7. 비고
- 현재 코드베이스 일부 파일은 한글 인코딩 깨짐이 존재하나, 이번 수정 로직은 실행/타입 기준으로 검증 완료
- `model/` 디렉터리는 현재 워크트리에서 untracked 상태로 보일 수 있음 (가중치/노트북 파일 보관 위치)
